<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›´æ–°æ—¥å¿— - æŸ¥çœ‹</title>
    <!-- GitHub å­˜å‚¨æ¨¡å— -->
    <script src="github-storage.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            border-left: 4px solid #ff8800;
            padding-left: 12px;
        }

        .load-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .load-btn:hover {
            background-color: #0b7dda;
        }

        .file-input {
            display: none;
        }

        /* æ—¶é—´çº¿æ ·å¼ */
        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 40px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -33px;
            top: 8px;
            width: 12px;
            height: 12px;
            background-color: #ff8800;
            border-radius: 50%;
            z-index: 2;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: -28px;
            top: 20px;
            width: 2px;
            height: calc(100% - 20px);
            background-color: #e0e0e0;
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .update-date {
            font-size: 18px;
            font-weight: bold;
            color: #ff8800;
            margin-bottom: 15px;
        }

        .update-content {
            background-color: #fafafa;
            padding: 20px;
            border-radius: 6px;
            border-left: 3px solid #ff8800;
        }

        .update-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .section-title {
            font-weight: bold;
            color: #333;
            margin: 15px 0 10px 0;
        }

        .update-list {
            list-style: none;
            padding-left: 0;
        }

        .update-list li {
            padding: 8px 0;
            color: #666;
            line-height: 1.6;
        }

        .update-list li::before {
            content: "â€¢ ";
            color: #ff8800;
            font-weight: bold;
            margin-right: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .info-banner {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #1976d2;
        }

        .info-banner p {
            margin: 5px 0;
            font-size: 14px;
        }

        /* é™„ä»¶ç›¸å…³æ ·å¼ */
        .attachments-display {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .attachments-display h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .attachment-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            margin: 5px 5px 5px 0;
            background-color: #e3f2fd;
            border-radius: 4px;
            text-decoration: none;
            color: #1976d2;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid #90caf9;
        }

        .attachment-link:hover {
            background-color: #bbdefb;
        }

        .attachment-preview {
            max-width: 200px;
            max-height: 150px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">æœ€æ–°åŠ¨æ€</div>
            <button class="load-btn" onclick="loadDataFile(document.getElementById('fileInput'))" style="display:none;">åŠ è½½æ•°æ®æ–‡ä»¶</button>
            <button class="load-btn" onclick="refreshFromGitHub()" id="refreshBtn">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <input type="file" id="fileInput" class="file-input" accept=".json" onchange="loadDataFile(event)" style="display:none;">
        </div>

        <!-- GitHub çŠ¶æ€æç¤º -->
        <div id="githubStatus" style="display: none; background-color: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
            <p style="color: #1976d2; font-size: 14px; margin-bottom: 5px;">
                <strong>ğŸ“¡ ä» GitHub è‡ªåŠ¨åŠ è½½æ•°æ®</strong>
            </p>
            <p style="color: #1565c0; font-size: 13px;" id="githubInfo"></p>
        </div>

        <div id="infoBanner" class="info-banner" style="display: none;">
            <p><strong>æ•°æ®åŠ è½½æˆåŠŸ</strong></p>
            <p id="infoText"></p>
        </div>

        <div class="timeline" id="timeline">
            <!-- æ›´æ–°æ—¥å¿—å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </div>
    </div>

    <script>
        // localStorage é”®åï¼ˆåªè¯»ï¼‰
        const STORAGE_KEY = 'updateLogs';

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initGitHubStatus();
            loadAndRenderLogs();
        });

        // åˆå§‹åŒ– GitHub çŠ¶æ€æ˜¾ç¤º
        function initGitHubStatus() {
            if (githubStorage.isConfigured()) {
                const config = githubStorage.getConfigInfo();
                const statusDiv = document.getElementById('githubStatus');
                const infoP = document.getElementById('githubInfo');

                infoP.innerHTML = `ä»“åº“ï¼š<a href="${config.repoUrl}" target="_blank" style="color: #1565c0; text-decoration: none;">${config.username}/${config.repo}</a> (${config.branch} åˆ†æ”¯)`;
                statusDiv.style.display = 'block';
            }
        }

        // ä» GitHub/localStorage è¯»å–æ•°æ®ï¼ˆåªè¯»ï¼‰
        async function loadLogs() {
            try {
                const logs = await githubStorage.loadLogs();
                return logs;
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                return [];
            }
        }

        // åˆ·æ–°æ•°æ®ï¼ˆä» GitHub é‡æ–°åŠ è½½ï¼‰
        async function refreshFromGitHub() {
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = 'â³ åˆ·æ–°ä¸­...';
            refreshBtn.disabled = true;

            try {
                const logs = await githubStorage.syncFromGitHub();
                await loadAndRenderLogs();

                // æ˜¾ç¤ºæç¤º
                const infoBanner = document.getElementById('infoBanner');
                const infoText = document.getElementById('infoText');
                infoText.textContent = `æˆåŠŸåˆ·æ–°ï¼å…± ${logs.length} æ¡æ›´æ–°æ—¥å¿—`;
                infoBanner.style.display = 'block';

                setTimeout(() => {
                    infoBanner.style.display = 'none';
                }, 3000);
            } catch (error) {
                alert('âŒ åˆ·æ–°å¤±è´¥ï¼š' + error.message);
            } finally {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }

        // æ¸²æŸ“å•ä¸ªæ—¥å¿—é¡¹
        function renderLogItem(log) {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';

            let contentHTML = `
                <div class="update-date">${escapeHtml(log.date)}</div>
                <div class="update-content">
                    <div class="update-title">${escapeHtml(log.title)}</div>
            `;

            if (log.importantItems && log.importantItems.length > 0) {
                contentHTML += '<div class="section-title">é‡è¦æ›´æ–°</div><ul class="update-list">';
                log.importantItems.forEach(item => {
                    contentHTML += `<li>${escapeHtml(item)}</li>`;
                });
                contentHTML += '</ul>';
            }

            if (log.dailyItems && log.dailyItems.length > 0) {
                contentHTML += '<div class="section-title">æ—¥å¸¸æ›´æ–°</div><ul class="update-list">';
                log.dailyItems.forEach(item => {
                    contentHTML += `<li>${escapeHtml(item)}</li>`;
                });
                contentHTML += '</ul>';
            }

            // æ·»åŠ é™„ä»¶æ˜¾ç¤º
            if (log.attachments && log.attachments.length > 0) {
                contentHTML += '<div class="attachments-display">';
                contentHTML += '<h4>ğŸ“ é™„ä»¶ (' + log.attachments.length + ')</h4>';

                log.attachments.forEach((att, attIndex) => {
                    if (att.isLocalFile) {
                        // æœ¬åœ°æ–‡ä»¶å¼•ç”¨ - æ·»åŠ é¢„è§ˆåŠŸèƒ½
                        const badge = '<span style="background: #4CAF50; color: white; padding: 1px 4px; border-radius: 2px; font-size: 10px; margin-left: 5px;">æœ¬åœ°</span>';

                        contentHTML += `<div class="attachment-link" style="border: 2px dashed #4CAF50; cursor: pointer; display: inline-block;"
                                        onclick="selectLocalFileForPreview(${index}, ${attIndex})"
                                        title="ç‚¹å‡»é€‰æ‹©æœ¬åœ°æ–‡ä»¶è¿›è¡Œé¢„è§ˆ">
                                        ${getFileIcon(att.name)} ${escapeHtml(att.name)} ${badge}
                                        <span style="font-size: 11px; color: #999;">(${formatFileSize(att.size)})</span>
                                        <br><span style="font-size: 10px; color: #FF9800;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶é¢„è§ˆ</span>
                                        </div>`;
                    } else {
                        // Base64å­˜å‚¨çš„æ–‡ä»¶
                        const isImage = att.type && att.type.startsWith('image/');
                        const isVideo = att.type && att.type.startsWith('video/');

                        if (isImage && att.data) {
                            // å›¾ç‰‡æ˜¾ç¤ºç¼©ç•¥å›¾
                            contentHTML += `<img src="${att.data}" alt="${escapeHtml(att.name)}" class="attachment-preview"
                                            onclick="window.open('${att.data}', '_blank')" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾">`;
                        } else if (isVideo && att.data) {
                            // è§†é¢‘æ˜¾ç¤ºæ’­æ”¾å™¨
                            const videoId = 'video_' + index + '_' + attIndex;
                            contentHTML += `<div style="display: inline-block; margin: 10px; max-width: 400px;">
                                            <video id="${videoId}" controls preload="metadata" style="max-width: 100%; border-radius: 4px; border: 1px solid #ddd;">
                                                <source src="${att.data}" type="${att.type}">
                                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                                            </video>
                                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                                ${getFileIcon(att.name)} ${escapeHtml(att.name)} (${formatFileSize(att.size)})
                                            </div>
                                            </div>`;
                        } else if (att.data) {
                            // å…¶ä»–æ–‡ä»¶æ˜¾ç¤ºä¸‹è½½é“¾æ¥
                            contentHTML += `<a class="attachment-link" href="javascript:void(0)" onclick="downloadAttachment('${att.data}', '${escapeHtml(att.name)}')" title="${formatFileSize(att.size)}">
                                            ${getFileIcon(att.name)} ${escapeHtml(att.name)}
                                            </a>`;
                        }
                    }
                });

                contentHTML += '</div>';
            }

            contentHTML += '</div>';
            timelineItem.innerHTML = contentHTML;

            return timelineItem;
        }

        // æ¸²æŸ“æ‰€æœ‰æ—¥å¿—
        async function loadAndRenderLogs() {
            const logs = await loadLogs();
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            if (logs.length === 0) {
                // æ˜¾ç¤ºç©ºçŠ¶æ€
                timeline.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— æ›´æ–°æ—¥å¿—</h3>
                        <p>è¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ æ›´æ–°æ—¥å¿—</p>
                        ${!githubStorage.isConfigured() ? '<p style="font-size: 12px; color: #bbb;">æˆ–ç‚¹å‡»ä¸Šæ–¹"åŠ è½½æ•°æ®æ–‡ä»¶"æŒ‰é’®å¯¼å…¥æ•°æ®</p>' : ''}
                    </div>
                `;
                return;
            }

            logs.forEach((log) => {
                timeline.appendChild(renderLogItem(log));
            });
        }

        // HTML è½¬ä¹‰ï¼Œé˜²æ­¢ XSSï¼ŒåŒæ—¶æ”¯æŒæ¢è¡Œ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br> æ ‡ç­¾
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // ä» JSON æ–‡ä»¶åŠ è½½æ•°æ®
        function loadDataFile(event) {
            const file = event.target.files[0];

            if (!file) {
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.json')) {
                alert('è¯·é€‰æ‹© JSON æ–‡ä»¶ï¼');
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!data.logs || !Array.isArray(data.logs)) {
                        alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
                        return;
                    }

                    // ä¿å­˜åˆ° localStorageï¼ˆä»…ç”¨äºå½“å‰ä¼šè¯æ˜¾ç¤ºï¼‰
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data.logs));

                    // é‡æ–°æ¸²æŸ“
                    loadAndRenderLogs();

                    // æ˜¾ç¤ºä¿¡æ¯æ¨ªå¹…
                    const infoBanner = document.getElementById('infoBanner');
                    const infoText = document.getElementById('infoText');

                    const exportDate = data.exportDate ? new Date(data.exportDate).toLocaleString('zh-CN') : 'æœªçŸ¥';
                    infoText.textContent = `å…±åŠ è½½ ${data.logs.length} æ¡æ›´æ–°æ—¥å¿— | æ•°æ®å¯¼å‡ºæ—¶é—´: ${exportDate}`;
                    infoBanner.style.display = 'block';

                    // 3ç§’åéšè—æ¨ªå¹…
                    setTimeout(() => {
                        infoBanner.style.display = 'none';
                    }, 5000);

                } catch (error) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼');
                    console.error(error);
                }

                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
                'doc': 'ğŸ“„', 'docx': 'ğŸ“„',
                'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬', 'wmv': 'ğŸ¬'
            };
            return icons[ext] || 'ğŸ“';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ä¸‹è½½é™„ä»¶
        function downloadAttachment(data, filename) {
            const a = document.createElement('a');
            a.href = data;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // é€‰æ‹©æœ¬åœ°æ–‡ä»¶è¿›è¡Œé¢„è§ˆ
        function selectLocalFileForPreview(logIndex, attIndex) {
            const logs = loadLogs();
            const log = logs[logIndex];
            if (!log || !log.attachments || !log.attachments[attIndex]) {
                console.error('é™„ä»¶å¼•ç”¨ä¸å­˜åœ¨');
                return;
            }

            const att = log.attachments[attIndex];

            // åˆ›å»ºæ–‡ä»¶é€‰æ‹©è¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'file';

            // æ ¹æ®é™„ä»¶ç±»å‹è®¾ç½®æ¥å—çš„æ–‡ä»¶ç±»å‹
            if (att.type) {
                input.accept = att.type;
            } else {
                // æ ¹æ®æ–‡ä»¶æ‰©å±•åçŒœæµ‹ç±»å‹
                const ext = att.name.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                    input.accept = 'image/*';
                } else if (['mp4', 'avi', 'mov', 'wmv'].includes(ext)) {
                    input.accept = 'video/*';
                } else if (['doc', 'docx'].includes(ext)) {
                    input.accept = '.doc,.docx';
                } else {
                    input.accept = '*/*';
                }
            }

            // æ–‡ä»¶é€‰æ‹©åçš„å¤„ç†
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) {
                    return;
                }

                // éªŒè¯æ–‡ä»¶åæ˜¯å¦åŒ¹é…ï¼ˆå¯é€‰ï¼Œç»™ç”¨æˆ·æç¤ºï¼‰
                if (file.name !== att.name) {
                    const confirmLoad = confirm(`é€‰æ‹©çš„æ–‡ä»¶å "${file.name}" ä¸åŸæ–‡ä»¶å "${att.name}" ä¸åŒ¹é…ã€‚\n\næ˜¯å¦ç»§ç»­é¢„è§ˆï¼Ÿ`);
                    if (!confirmLoad) {
                        return;
                    }
                }

                const isImage = file.type.startsWith('image/');
                const isVideo = file.type.startsWith('video/');

                if (isImage) {
                    // é¢„è§ˆå›¾ç‰‡
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        showImagePreview(event.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                } else if (isVideo) {
                    // é¢„è§ˆè§†é¢‘
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        showVideoPreview(event.target.result, file.name, file.type);
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('è¯¥æ–‡ä»¶ç±»å‹ä¸æ”¯æŒé¢„è§ˆï¼Œä»…æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘é¢„è§ˆã€‚');
                }
            };

            // è§¦å‘æ–‡ä»¶é€‰æ‹©
            input.click();
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function showImagePreview(dataUrl, filename) {
            // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = 'display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000;';

            modal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%; margin: 50px auto; text-align: center;">
                    <span onclick="this.parentElement.parentElement.remove()" style="cursor: pointer; position: fixed; right: 30px; top: 30px; z-index: 1001; background: rgba(0,0,0,0.7); color: white; width: 40px; height: 40px; text-align: center; line-height: 40px; border-radius: 50%; font-size: 28px;">&times;</span>
                    <img src="${dataUrl}" alt="${escapeHtml(filename)}" style="max-width: 100%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <div style="color: white; margin-top: 15px; font-size: 14px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 4px; display: inline-block;">
                        ${escapeHtml(filename)} [æœ¬åœ°æ–‡ä»¶]
                    </div>
                </div>
            `;

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };

            document.body.appendChild(modal);
        }

        // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ
        function showVideoPreview(dataUrl, filename, mimeType) {
            // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = 'display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000;';

            modal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%; margin: 50px auto; text-align: center;">
                    <span onclick="this.parentElement.parentElement.remove()" style="cursor: pointer; position: fixed; right: 30px; top: 30px; z-index: 1001; background: rgba(0,0,0,0.7); color: white; width: 40px; height: 40px; text-align: center; line-height: 40px; border-radius: 50%; font-size: 28px;">&times;</span>
                    <video controls autoplay preload="metadata" style="max-width: 100%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <source src="${dataUrl}" type="${mimeType}">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                    </video>
                    <div style="color: white; margin-top: 15px; font-size: 14px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 4px; display: inline-block;">
                        ${escapeHtml(filename)} [æœ¬åœ°æ–‡ä»¶]
                    </div>
                </div>
            `;

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };

            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
