<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›´æ–°æ—¥å¿—</title>
    <!-- SheetJS åº“ç”¨äºå¤„ç† Excel æ–‡ä»¶ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- GitHub å­˜å‚¨æ¨¡å— -->
    <script src="github-storage.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            border-left: 4px solid #ff8800;
            padding-left: 12px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .add-btn {
            background-color: #ff8800;
        }

        .add-btn:hover {
            background-color: #ff9922;
        }

        .export-btn {
            background-color: #4CAF50;
        }

        .export-btn:hover {
            background-color: #45a049;
        }

        .import-btn {
            background-color: #2196F3;
        }

        .import-btn:hover {
            background-color: #0b7dda;
        }

        .clear-btn {
            background-color: #f44336;
        }

        .clear-btn:hover {
            background-color: #da190b;
        }

        .file-input {
            display: none;
        }

        /* æ—¶é—´çº¿æ ·å¼ */
        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 40px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -33px;
            top: 8px;
            width: 12px;
            height: 12px;
            background-color: #ff8800;
            border-radius: 50%;
            z-index: 2;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: -28px;
            top: 20px;
            width: 2px;
            height: calc(100% - 20px);
            background-color: #e0e0e0;
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .update-date {
            font-size: 18px;
            font-weight: bold;
            color: #ff8800;
            margin-bottom: 15px;
        }

        .update-content {
            background-color: #fafafa;
            padding: 20px;
            border-radius: 6px;
            border-left: 3px solid #ff8800;
            position: relative;
        }

        .delete-log-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .delete-log-btn:hover {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
        }

        .update-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .section-title {
            font-weight: bold;
            color: #333;
            margin: 15px 0 10px 0;
        }

        .update-list {
            list-style: none;
            padding-left: 0;
        }

        .update-list li {
            padding: 8px 0;
            color: #666;
            line-height: 1.6;
        }

        .update-list li::before {
            content: "â€¢ ";
            color: #ff8800;
            font-weight: bold;
            margin-right: 8px;
        }

        .link-text {
            color: #1890ff;
            cursor: pointer;
            text-decoration: none;
        }

        .link-text:hover {
            text-decoration: underline;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            background-color: white;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .update-items {
            margin-top: 10px;
        }

        .update-item-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-start;
        }

        .update-item-input input,
        .update-item-input textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }

        .remove-item-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .add-item-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .submit-btn {
            background-color: #ff8800;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .submit-btn:hover {
            background-color: #ff9922;
        }

        .simple-update {
            color: #999;
            font-size: 14px;
        }

        /* é™„ä»¶ç›¸å…³æ ·å¼ */
        .attachment-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .attachment-icon {
            font-size: 20px;
        }

        .attachment-name {
            flex: 1;
            font-size: 14px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-size {
            font-size: 12px;
            color: #999;
        }

        .attachment-remove {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .attachments-display {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .attachments-display h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .attachment-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            margin: 5px 5px 5px 0;
            background-color: #e3f2fd;
            border-radius: 4px;
            text-decoration: none;
            color: #1976d2;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid #90caf9;
        }

        .attachment-link:hover {
            background-color: #bbdefb;
        }

        .attachment-preview {
            max-width: 200px;
            max-height: 150px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">æœ€æ–°åŠ¨æ€</div>
            <div class="header-actions">
                <button class="btn" onclick="window.location.href='config.html'" style="background-color: #9C27B0;">âš™ï¸ GitHubé…ç½®</button>
                <button class="btn" onclick="syncFromGitHub()" style="background-color: #2196F3;" id="syncBtn">ğŸ”„ åŒæ­¥æ•°æ®</button>
                <button class="btn export-btn" onclick="exportToExcel()">å¯¼å‡ºExcel</button>
                <button class="btn export-btn" onclick="exportAllAttachments()" style="background-color: #FF9800;">å¯¼å‡ºå…¨éƒ¨é™„ä»¶</button>
                <button class="btn import-btn" onclick="document.getElementById('fileInput').click()">å¯¼å…¥Excel</button>
                <button class="btn export-btn" onclick="downloadExcelTemplate()" style="background-color: #9C27B0;">ä¸‹è½½æ¨¡æ¿</button>
                <button class="btn clear-btn" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
                <button class="btn add-btn" onclick="openModal()">+ æ·»åŠ æ›´æ–°æ—¥å¿—</button>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" onchange="importFromExcel(event)">
        </div>

        <!-- GitHub çŠ¶æ€æç¤º -->
        <div id="githubStatus" style="display: none; background-color: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
            <p style="color: #1976d2; font-size: 14px; margin-bottom: 5px;">
                <strong>ğŸ“¡ GitHub åœ¨çº¿å­˜å‚¨å·²å¯ç”¨</strong>
            </p>
            <p style="color: #1565c0; font-size: 13px;" id="githubInfo"></p>
        </div>

        <div class="timeline" id="timeline">
            <!-- æ›´æ–°æ—¥å¿—å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </div>
    </div>

    <!-- æ·»åŠ æ›´æ–°æ—¥å¿—çš„æ¨¡æ€æ¡† -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #333;">æ·»åŠ æ›´æ–°æ—¥å¿—</h2>

            <form id="updateForm" onsubmit="addUpdate(event)">
                <div class="form-group">
                    <label>æ›´æ–°æ—¥æœŸ</label>
                    <input type="date" id="updateDate" required>
                </div>

                <div class="form-group">
                    <label>æ›´æ–°æ ‡é¢˜</label>
                    <input type="text" id="updateTitle" placeholder="ä¾‹å¦‚ï¼š2025-12-21å‘¨æ›´æ–°" required>
                </div>

                <div class="form-group">
                    <label>é‡è¦æ›´æ–°</label>
                    <div id="importantUpdates" class="update-items"></div>
                    <button type="button" class="add-item-btn" onclick="addUpdateItem('important')">+ æ·»åŠ é‡è¦æ›´æ–°</button>
                </div>

                <div class="form-group">
                    <label>æ—¥å¸¸æ›´æ–°</label>
                    <div id="dailyUpdates" class="update-items"></div>
                    <button type="button" class="add-item-btn" onclick="addUpdateItem('daily')">+ æ·»åŠ æ—¥å¸¸æ›´æ–°</button>
                </div>

                <div class="form-group">
                    <label>ä¸Šä¼ é™„ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                    <p style="font-size: 12px; color: #999; margin-bottom: 10px;">
                        æ”¯æŒï¼šå›¾ç‰‡ï¼ˆjpg, png, gifï¼‰ã€Wordæ–‡æ¡£ï¼ˆdoc, docxï¼‰ã€è§†é¢‘ï¼ˆmp4, aviï¼‰
                        <br><strong>æ™ºèƒ½å­˜å‚¨ï¼š</strong>å°æ–‡ä»¶(&lt;1MB)å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­ï¼Œå¤§æ–‡ä»¶(&ge;1MB)è‡ªåŠ¨ä¸‹è½½åˆ°æœ¬åœ°
                    </p>
                    <input type="file" id="attachmentInput" multiple
                           accept=".jpg,.jpeg,.png,.gif,.doc,.docx,.mp4,.avi,.mov,.wmv"
                           onchange="handleAttachmentChange(event)">
                    <div id="attachmentList" style="margin-top: 10px;"></div>
                </div>

                <button type="submit" class="submit-btn">æäº¤æ›´æ–°</button>
            </form>
        </div>
    </div>

    <!-- é™„ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="previewModal" class="modal" onclick="closePreview(event)">
        <div style="position: relative; max-width: 90%; max-height: 90%; margin: 50px auto;">
            <span class="close-btn" onclick="closePreview()" style="position: fixed; right: 30px; top: 30px; z-index: 1001; background: rgba(0,0,0,0.7); color: white; width: 40px; height: 40px; text-align: center; line-height: 40px; border-radius: 50%;">&times;</span>
            <div id="previewContent" style="text-align: center;"></div>
        </div>
    </div>

    <script>
        // localStorage é”®å
        const STORAGE_KEY = 'updateLogs';

        // å½“å‰é€‰ä¸­çš„é™„ä»¶ï¼ˆä¸´æ—¶å­˜å‚¨ï¼‰
        let currentAttachments = [];

        // å­˜å‚¨æ‰€æœ‰æ—¥å¿—æ•°æ®ä¾›é¢„è§ˆä½¿ç”¨
        let allLogsData = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initGitHubStatus();
            loadAndRenderLogs();
        });

        // åˆå§‹åŒ– GitHub çŠ¶æ€æ˜¾ç¤º
        function initGitHubStatus() {
            if (githubStorage.isConfigured()) {
                const config = githubStorage.getConfigInfo();
                const statusDiv = document.getElementById('githubStatus');
                const infoP = document.getElementById('githubInfo');

                infoP.innerHTML = `ä»“åº“ï¼š<a href="${config.repoUrl}" target="_blank" style="color: #1565c0; text-decoration: none;">${config.username}/${config.repo}</a> (${config.branch} åˆ†æ”¯)`;
                statusDiv.style.display = 'block';
            }
        }

        // ä» GitHub/localStorage åŠ è½½æ•°æ®
        async function loadLogs() {
            try {
                const logs = await githubStorage.loadLogs();
                return logs;
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                return [];
            }
        }

        // ä¿å­˜æ•°æ®åˆ° GitHub/localStorage
        async function saveLogs(logs) {
            try {
                const success = await githubStorage.saveLogs(logs);
                return success;
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                // å¤±è´¥æ—¶è‡³å°‘å°è¯•ä¿å­˜åˆ°æœ¬åœ°
                return githubStorage.saveLogsToLocal(logs);
            }
        }

        // æ‰‹åŠ¨ä» GitHub åŒæ­¥æ•°æ®
        async function syncFromGitHub() {
            if (!githubStorage.isConfigured()) {
                alert('è¯·å…ˆé…ç½® GitHub è¿æ¥ï¼\n\nç‚¹å‡»å·¦ä¸Šè§’"GitHubé…ç½®"æŒ‰é’®è¿›è¡Œé…ç½®ã€‚');
                return;
            }

            const syncBtn = document.getElementById('syncBtn');
            const originalText = syncBtn.innerHTML;
            syncBtn.innerHTML = 'â³ åŒæ­¥ä¸­...';
            syncBtn.disabled = true;

            try {
                const logs = await githubStorage.syncFromGitHub();
                await loadAndRenderLogs();
                alert(`âœ… åŒæ­¥æˆåŠŸï¼\n\nä» GitHub åŠ è½½äº† ${logs.length} æ¡æ›´æ–°æ—¥å¿—ã€‚`);
            } catch (error) {
                alert('âŒ åŒæ­¥å¤±è´¥ï¼š' + error.message);
            } finally {
                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;
            }
        }

        // æ¸²æŸ“å•ä¸ªæ—¥å¿—é¡¹
        function renderLogItem(log, index) {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';
            timelineItem.dataset.index = index;

            let contentHTML = `
                <div class="update-date">${log.date}</div>
                <div class="update-content">
                    <button class="delete-log-btn" onclick="deleteLog(${index})">åˆ é™¤</button>
                    <div class="update-title">${log.title}</div>
            `;

            if (log.importantItems && log.importantItems.length > 0) {
                contentHTML += '<div class="section-title">é‡è¦æ›´æ–°</div><ul class="update-list">';
                log.importantItems.forEach(item => {
                    contentHTML += `<li>${escapeHtml(item)}</li>`;
                });
                contentHTML += '</ul>';
            }

            if (log.dailyItems && log.dailyItems.length > 0) {
                contentHTML += '<div class="section-title">æ—¥å¸¸æ›´æ–°</div><ul class="update-list">';
                log.dailyItems.forEach(item => {
                    contentHTML += `<li>${escapeHtml(item)}</li>`;
                });
                contentHTML += '</ul>';
            }

            // æ·»åŠ é™„ä»¶æ˜¾ç¤º
            if (log.attachments && log.attachments.length > 0) {
                contentHTML += '<div class="attachments-display">';
                contentHTML += '<h4>ğŸ“ é™„ä»¶ (' + log.attachments.length + ')</h4>';

                log.attachments.forEach((att, attIndex) => {
                    if (att.isLocalFile) {
                        // æœ¬åœ°æ–‡ä»¶å¼•ç”¨ - æ·»åŠ é¢„è§ˆåŠŸèƒ½
                        const badge = '<span style="background: #4CAF50; color: white; padding: 1px 4px; border-radius: 2px; font-size: 10px; margin-left: 5px;">æœ¬åœ°</span>';
                        const isImage = att.type && att.type.startsWith('image/');
                        const isVideo = att.type && att.type.startsWith('video/');

                        contentHTML += `<div class="attachment-link" style="border: 2px dashed #4CAF50; cursor: pointer; display: inline-block;"
                                        onclick="selectLocalFileForPreview(${index}, ${attIndex})"
                                        title="ç‚¹å‡»é€‰æ‹©æœ¬åœ°æ–‡ä»¶è¿›è¡Œé¢„è§ˆ">
                                        ${getFileIcon(att.name)} ${escapeHtml(att.name)} ${badge}
                                        <span style="font-size: 11px; color: #999;">(${formatFileSize(att.size)})</span>
                                        <br><span style="font-size: 10px; color: #FF9800;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶é¢„è§ˆ</span>
                                        </div>`;
                    } else {
                        // Base64å­˜å‚¨çš„æ–‡ä»¶
                        const isImage = att.type && att.type.startsWith('image/');
                        const isVideo = att.type && att.type.startsWith('video/');

                        if (isImage && att.data) {
                            // å›¾ç‰‡ï¼šæ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œç‚¹å‡»æ”¾å¤§
                            contentHTML += `<div style="display: inline-block; margin: 5px; position: relative;">
                                            <img src="${att.data}" alt="${escapeHtml(att.name)}" class="attachment-preview"
                                                onclick="showPreview(${index}, ${attIndex})"
                                                style="cursor: pointer;"
                                                title="ç‚¹å‡»é¢„è§ˆå¤§å›¾">
                                            <div style="font-size: 11px; color: #666; text-align: center; margin-top: 3px;">${escapeHtml(att.name)}</div>
                                            </div>`;
                        } else if (isVideo && att.data) {
                            // è§†é¢‘ï¼šæ˜¾ç¤ºæ’­æ”¾å™¨
                            const videoId = 'video_' + index + '_' + attIndex;
                            contentHTML += `<div style="display: inline-block; margin: 10px; max-width: 400px;">
                                            <video id="${videoId}" controls preload="metadata" style="max-width: 100%; border-radius: 4px; border: 1px solid #ddd;">
                                                <source src="${att.data}" type="${att.type}">
                                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                                            </video>
                                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                                ${getFileIcon(att.name)} ${escapeHtml(att.name)} (${formatFileSize(att.size)})
                                                <a href="javascript:void(0)" onclick="downloadAttachmentByIndex(${index}, ${attIndex})" style="margin-left: 10px; color: #1976d2; text-decoration: none;">ä¸‹è½½</a>
                                            </div>
                                            </div>`;
                        } else if (att.data) {
                            // å…¶ä»–æ–‡ä»¶ï¼šæ˜¾ç¤ºä¸‹è½½é“¾æ¥
                            contentHTML += `<a class="attachment-link" href="javascript:void(0)" onclick="downloadAttachmentByIndex(${index}, ${attIndex})" title="${formatFileSize(att.size)}">
                                            ${getFileIcon(att.name)} ${escapeHtml(att.name)}
                                            </a>`;
                        }
                    }
                });

                contentHTML += '</div>';
            }

            contentHTML += '</div>';
            timelineItem.innerHTML = contentHTML;

            return timelineItem;
        }

        // æ¸²æŸ“æ‰€æœ‰æ—¥å¿—
        async function loadAndRenderLogs() {
            const logs = await loadLogs();
            allLogsData = logs; // ä¿å­˜åˆ°å…¨å±€å˜é‡
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            if (logs.length === 0) {
                // æ˜¾ç¤ºç©ºçŠ¶æ€
                timeline.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— æ›´æ–°æ—¥å¿—</h3>
                        <p>ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ æ›´æ–°æ—¥å¿—"æŒ‰é’®å¼€å§‹æ·»åŠ </p>
                    </div>
                `;
                return;
            }

            logs.forEach((log, index) => {
                timeline.appendChild(renderLogItem(log, index));
            });
        }

        // åˆ é™¤æ—¥å¿—
        async function deleteLog(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ›´æ–°æ—¥å¿—å—ï¼Ÿ')) {
                const logs = await loadLogs();
                logs.splice(index, 1);
                await saveLogs(logs);
                await loadAndRenderLogs();
            }
        }

        // HTML è½¬ä¹‰ï¼Œé˜²æ­¢ XSSï¼ŒåŒæ—¶æ”¯æŒæ¢è¡Œ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br> æ ‡ç­¾
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // æ‰“å¼€æ¨¡æ€æ¡†
        function openModal() {
            document.getElementById('modal').style.display = 'block';
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            document.getElementById('updateDate').valueAsDate = new Date();
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('updateForm').reset();
            document.getElementById('importantUpdates').innerHTML = '';
            document.getElementById('dailyUpdates').innerHTML = '';
            document.getElementById('attachmentList').innerHTML = '';
            currentAttachments = [];
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // æ·»åŠ æ›´æ–°é¡¹è¾“å…¥æ¡†
        function addUpdateItem(type) {
            const container = type === 'important' ? document.getElementById('importantUpdates') : document.getElementById('dailyUpdates');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'update-item-input';
            itemDiv.innerHTML = `
                <textarea placeholder="è¾“å…¥æ›´æ–°å†…å®¹ï¼ˆæ”¯æŒæ¢è¡Œï¼‰" class="${type}-item" rows="3"></textarea>
                <button type="button" class="remove-item-btn" onclick="removeUpdateItem(this)">åˆ é™¤</button>
            `;
            container.appendChild(itemDiv);
        }

        // åˆ é™¤æ›´æ–°é¡¹
        function removeUpdateItem(button) {
            button.parentElement.remove();
        }

        // ===== é™„ä»¶å¤„ç†å‡½æ•° =====

        // å¤„ç†é™„ä»¶é€‰æ‹©
        function handleAttachmentChange(event) {
            const files = Array.from(event.target.files);
            const SIZE_THRESHOLD = 1 * 1024 * 1024; // 1MB

            let largeFilesCount = 0;

            files.forEach(file => {
                if (file.size >= SIZE_THRESHOLD) {
                    // å¤§æ–‡ä»¶ï¼šè‡ªåŠ¨ä¸‹è½½åˆ°æœ¬åœ°ï¼Œåªå­˜å‚¨å¼•ç”¨
                    largeFilesCount++;

                    const attachment = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        isLocalFile: true, // æ ‡è®°ä¸ºæœ¬åœ°æ–‡ä»¶
                        downloadedAt: new Date().toISOString()
                    };

                    currentAttachments.push(attachment);

                    // è‡ªåŠ¨è§¦å‘ä¸‹è½½
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                } else {
                    // å°æ–‡ä»¶ï¼šå­˜å‚¨Base64
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const attachment = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: e.target.result, // Base64 æ•°æ®
                            isLocalFile: false // æ ‡è®°ä¸ºBase64å­˜å‚¨
                        };

                        currentAttachments.push(attachment);
                        displayAttachmentList();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // æ˜¾ç¤ºé™„ä»¶åˆ—è¡¨ï¼ˆåŒ…æ‹¬å¤§æ–‡ä»¶ï¼‰
            if (largeFilesCount > 0) {
                displayAttachmentList();
                alert(`å·²è‡ªåŠ¨ä¸‹è½½ ${largeFilesCount} ä¸ªå¤§æ–‡ä»¶åˆ°æœ¬åœ°ï¼\n\nè¿™äº›æ–‡ä»¶å°†ä½œä¸ºæœ¬åœ°æ–‡ä»¶å¼•ç”¨ä¿å­˜ã€‚\nè¯·å°†ä¸‹è½½çš„æ–‡ä»¶ä¿å­˜åœ¨å›ºå®šä½ç½®ï¼Œä»¥ä¾¿æŸ¥çœ‹æ—¶ä½¿ç”¨ã€‚`);
            }

            // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // æ˜¾ç¤ºé™„ä»¶åˆ—è¡¨
        function displayAttachmentList() {
            const container = document.getElementById('attachmentList');
            container.innerHTML = '';

            currentAttachments.forEach((att, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-item';

                const storageType = att.isLocalFile ?
                    '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">æœ¬åœ°æ–‡ä»¶</span>' :
                    '<span style="background: #2196F3; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">æµè§ˆå™¨</span>';

                item.innerHTML = `
                    <span class="attachment-icon">${getFileIcon(att.name)}</span>
                    <span class="attachment-name" title="${att.name}">${att.name}</span>
                    ${storageType}
                    <span class="attachment-size">${formatFileSize(att.size)}</span>
                    <button type="button" class="attachment-remove" onclick="removeAttachment(${index})">åˆ é™¤</button>
                `;
                container.appendChild(item);
            });
        }

        // åˆ é™¤é™„ä»¶
        function removeAttachment(index) {
            currentAttachments.splice(index, 1);
            displayAttachmentList();
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
                'doc': 'ğŸ“„', 'docx': 'ğŸ“„',
                'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬', 'wmv': 'ğŸ¬'
            };
            return icons[ext] || 'ğŸ“';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ä¸‹è½½é™„ä»¶
        function downloadAttachment(data, filename) {
            const a = document.createElement('a');
            a.href = data;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // æäº¤æ›´æ–°
        async function addUpdate(event) {
            event.preventDefault();

            const date = document.getElementById('updateDate').value;
            const title = document.getElementById('updateTitle').value;
            const importantItems = Array.from(document.querySelectorAll('.important-item'))
                .map(input => input.value)
                .filter(v => v.trim());
            const dailyItems = Array.from(document.querySelectorAll('.daily-item'))
                .map(input => input.value)
                .filter(v => v.trim());

            // æ ¼å¼åŒ–æ—¥æœŸ
            const formattedDate = date.replace(/-/g, '.');

            // åˆ›å»ºæ–°çš„æ—¥å¿—å¯¹è±¡
            const newLog = {
                date: formattedDate,
                title: title,
                importantItems: importantItems,
                dailyItems: dailyItems,
                attachments: currentAttachments.length > 0 ? [...currentAttachments] : [],
                timestamp: new Date(date).getTime()
            };

            // åŠ è½½ç°æœ‰æ—¥å¿—
            const logs = await loadLogs();

            // æ·»åŠ æ–°æ—¥å¿—åˆ°å¼€å¤´
            logs.unshift(newLog);

            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            logs.sort((a, b) => b.timestamp - a.timestamp);

            // ä¿å­˜åˆ° GitHub
            await saveLogs(logs);

            // é‡æ–°æ¸²æŸ“
            await loadAndRenderLogs();

            // å…³é—­æ¨¡æ€æ¡†
            closeModal();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            alert('æ›´æ–°æ—¥å¿—æ·»åŠ æˆåŠŸï¼');
        }

        // å¯¼å‡ºæ•°æ®ä¸º JSON æ–‡ä»¶
        async function exportData() {
            const logs = await loadLogs();

            if (logs.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }

            // åˆ›å»ºæ•°æ®å¯¹è±¡
            const data = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                logs: logs
            };

            // è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
            const jsonStr = JSON.stringify(data, null, 2);

            // åˆ›å»º Blob å¯¹è±¡
            const blob = new Blob([jsonStr], { type: 'application/json' });

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // ç”Ÿæˆæ–‡ä»¶åï¼šupdate-logs-YYYYMMDD.json
            const today = new Date();
            const dateStr = today.getFullYear() +
                          String(today.getMonth() + 1).padStart(2, '0') +
                          String(today.getDate()).padStart(2, '0');
            a.download = `update-logs-${dateStr}.json`;

            // è§¦å‘ä¸‹è½½
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        }

        // å¯¼å…¥æ•°æ®ä» JSON æ–‡ä»¶
        async function importData(event) {
            const file = event.target.files[0];

            if (!file) {
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.json')) {
                alert('è¯·é€‰æ‹© JSON æ–‡ä»¶ï¼');
                return;
            }

            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!data.logs || !Array.isArray(data.logs)) {
                        alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
                        return;
                    }

                    // è¯¢é—®ç”¨æˆ·æ˜¯è¦†ç›–è¿˜æ˜¯åˆå¹¶
                    const action = confirm('ç‚¹å‡»"ç¡®å®š"è¦†ç›–ç°æœ‰æ•°æ®\nç‚¹å‡»"å–æ¶ˆ"åˆå¹¶åˆ°ç°æœ‰æ•°æ®');

                    let logs = [];
                    if (action) {
                        // è¦†ç›–æ¨¡å¼
                        logs = data.logs;
                    } else {
                        // åˆå¹¶æ¨¡å¼
                        const existingLogs = await loadLogs();
                        logs = [...existingLogs, ...data.logs];

                        // å»é‡ï¼šåŸºäºæ—¥æœŸå’Œæ ‡é¢˜
                        const uniqueLogs = [];
                        const seen = new Set();

                        logs.forEach(log => {
                            const key = `${log.date}-${log.title}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                uniqueLogs.push(log);
                            }
                        });

                        logs = uniqueLogs;
                    }

                    // æŒ‰æ—¥æœŸæ’åº
                    logs.sort((a, b) => b.timestamp - a.timestamp);

                    // ä¿å­˜åˆ° GitHub
                    await saveLogs(logs);

                    // é‡æ–°æ¸²æŸ“
                    await loadAndRenderLogs();

                    alert(`æ•°æ®å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${data.logs.length} æ¡è®°å½•ã€‚`);
                } catch (error) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼');
                    console.error(error);
                }

                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAllData() {
            const logs = await loadLogs();

            if (logs.length === 0) {
                alert('å½“å‰æ²¡æœ‰æ•°æ®ï¼');
                return;
            }

            if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\nè¿™å°†åˆ é™¤ ${logs.length} æ¡æ›´æ–°æ—¥å¿—ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                // æ¸…ç©ºæ•°æ®
                await saveLogs([]);

                // é‡æ–°æ¸²æŸ“
                await loadAndRenderLogs();

                alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }

        // ä¸‹è½½å¯¼å…¥æ¨¡æ¿
        function downloadTemplate() {
            // åˆ›å»ºç¤ºä¾‹æ•°æ®
            const templateData = {
                exportDate: new Date().toISOString(),
                version: "1.0",
                logs: [
                    {
                        date: "2025.12.26",
                        title: "2025-12-26å‘¨æ›´æ–°",
                        importantItems: [
                            "è¿™æ˜¯ä¸€ä¸ªé‡è¦æ›´æ–°ç¤ºä¾‹\nå¯ä»¥ä½¿ç”¨æ¢è¡Œæ¥åˆ†æ®µè¯´æ˜",
                            "ç¬¬äºŒä¸ªé‡è¦æ›´æ–°é¡¹"
                        ],
                        dailyItems: [
                            "è¿™æ˜¯ä¸€ä¸ªæ—¥å¸¸æ›´æ–°ç¤ºä¾‹",
                            "æ”¯æŒå¤šè¡Œæ–‡æœ¬\nç¬¬äºŒè¡Œå†…å®¹\nç¬¬ä¸‰è¡Œå†…å®¹",
                            "ç¬¬ä¸‰ä¸ªæ—¥å¸¸æ›´æ–°é¡¹"
                        ],
                        timestamp: new Date("2025-12-26").getTime()
                    },
                    {
                        date: "2025.12.20",
                        title: "2025-12-20å‘¨æ›´æ–°",
                        importantItems: [
                            "ç¤ºä¾‹é‡è¦æ›´æ–°"
                        ],
                        dailyItems: [
                            "ç¤ºä¾‹æ—¥å¸¸æ›´æ–°1",
                            "ç¤ºä¾‹æ—¥å¸¸æ›´æ–°2"
                        ],
                        timestamp: new Date("2025-12-20").getTime()
                    }
                ]
            };

            // è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
            const jsonStr = JSON.stringify(templateData, null, 2);

            // åˆ›å»º Blob å¯¹è±¡
            const blob = new Blob([jsonStr], { type: 'application/json' });

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'update-logs-template.json';

            // è§¦å‘ä¸‹è½½
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('æ¨¡æ¿æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼\n\nä½¿ç”¨è¯´æ˜ï¼š\n1. æ‰“å¼€æ¨¡æ¿æ–‡ä»¶è¿›è¡Œç¼–è¾‘\n2. ä¿®æ”¹æ—¥æœŸã€æ ‡é¢˜å’Œæ›´æ–°å†…å®¹\n3. ä¿å­˜åé€šè¿‡"å¯¼å…¥æ•°æ®"åŠŸèƒ½å¯¼å…¥');
        }

        // ===== Excel å¤„ç†å‡½æ•° =====

        // å¯¼å‡ºä¸º Excel
        async function exportToExcel() {
            const logs = await loadLogs();

            if (logs.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }

            // å‡†å¤‡Excelæ•°æ®
            const excelData = [];

            // æ·»åŠ è¡¨å¤´
            excelData.push(['æ—¥æœŸ', 'æ ‡é¢˜', 'ç±»å‹', 'å†…å®¹']);

            // éå†æ‰€æœ‰æ—¥å¿—
            logs.forEach(log => {
                // æ·»åŠ é‡è¦æ›´æ–°
                if (log.importantItems && log.importantItems.length > 0) {
                    log.importantItems.forEach(item => {
                        excelData.push([log.date, log.title, 'é‡è¦æ›´æ–°', item]);
                    });
                }

                // æ·»åŠ æ—¥å¸¸æ›´æ–°
                if (log.dailyItems && log.dailyItems.length > 0) {
                    log.dailyItems.forEach(item => {
                        excelData.push([log.date, log.title, 'æ—¥å¸¸æ›´æ–°', item]);
                    });
                }

                // å¦‚æœæ²¡æœ‰ä»»ä½•æ›´æ–°é¡¹ï¼Œè‡³å°‘æ·»åŠ ä¸€è¡ŒåŸºæœ¬ä¿¡æ¯
                if ((!log.importantItems || log.importantItems.length === 0) &&
                    (!log.dailyItems || log.dailyItems.length === 0)) {
                    excelData.push([log.date, log.title, '', '']);
                }
            });

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                { wch: 15 },  // æ—¥æœŸåˆ—
                { wch: 25 },  // æ ‡é¢˜åˆ—
                { wch: 12 },  // ç±»å‹åˆ—
                { wch: 50 }   // å†…å®¹åˆ—
            ];

            // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, 'æ›´æ–°æ—¥å¿—');

            // ç”Ÿæˆæ–‡ä»¶å
            const today = new Date();
            const dateStr = today.getFullYear() +
                          String(today.getMonth() + 1).padStart(2, '0') +
                          String(today.getDate()).padStart(2, '0');

            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, `update-logs-${dateStr}.xlsx`);

            alert('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
        }

        // ä» Excel å¯¼å…¥
        async function importFromExcel(event) {
            const file = event.target.files[0];

            if (!file) {
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('è¯·é€‰æ‹© Excel æ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰ï¼');
                return;
            }

            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    // è¯»å–Excelæ–‡ä»¶
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // è½¬æ¢ä¸ºJSONæ•°ç»„
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (jsonData.length < 2) {
                        alert('Excelæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼è¯·ç¡®ä¿æ–‡ä»¶åŒ…å«è¡¨å¤´å’Œæ•°æ®ã€‚');
                        return;
                    }

                    // æ£€æŸ¥è¡¨å¤´
                    const header = jsonData[0];
                    if (!header.includes('æ—¥æœŸ') || !header.includes('æ ‡é¢˜') || !header.includes('ç±»å‹') || !header.includes('å†…å®¹')) {
                        alert('Excelæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼\nè¡¨å¤´åº”åŒ…å«ï¼šæ—¥æœŸã€æ ‡é¢˜ã€ç±»å‹ã€å†…å®¹');
                        return;
                    }

                    // è§£ææ•°æ®
                    const logsMap = new Map();

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;

                        const date = row[0] ? String(row[0]).trim() : '';
                        const title = row[1] ? String(row[1]).trim() : '';
                        const type = row[2] ? String(row[2]).trim() : '';
                        const content = row[3] ? String(row[3]).trim() : '';

                        if (!date || !title) continue;

                        // ä½¿ç”¨æ—¥æœŸ+æ ‡é¢˜ä½œä¸ºå”¯ä¸€é”®
                        const key = `${date}-${title}`;

                        if (!logsMap.has(key)) {
                            logsMap.set(key, {
                                date: date,
                                title: title,
                                importantItems: [],
                                dailyItems: [],
                                timestamp: parseDateToTimestamp(date)
                            });
                        }

                        const log = logsMap.get(key);

                        if (content) {
                            if (type === 'é‡è¦æ›´æ–°') {
                                log.importantItems.push(content);
                            } else if (type === 'æ—¥å¸¸æ›´æ–°') {
                                log.dailyItems.push(content);
                            }
                        }
                    }

                    // è½¬æ¢ä¸ºæ•°ç»„
                    const newLogs = Array.from(logsMap.values());

                    if (newLogs.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼');
                        return;
                    }

                    // è¯¢é—®ç”¨æˆ·æ˜¯è¦†ç›–è¿˜æ˜¯åˆå¹¶
                    const action = confirm('ç‚¹å‡»"ç¡®å®š"è¦†ç›–ç°æœ‰æ•°æ®\nç‚¹å‡»"å–æ¶ˆ"åˆå¹¶åˆ°ç°æœ‰æ•°æ®');

                    let logs = [];
                    if (action) {
                        // è¦†ç›–æ¨¡å¼
                        logs = newLogs;
                    } else {
                        // åˆå¹¶æ¨¡å¼
                        const existingLogs = await loadLogs();
                        logs = [...existingLogs, ...newLogs];

                        // å»é‡
                        const uniqueLogs = [];
                        const seen = new Set();

                        logs.forEach(log => {
                            const key = `${log.date}-${log.title}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                uniqueLogs.push(log);
                            }
                        });

                        logs = uniqueLogs;
                    }

                    // æŒ‰æ—¥æœŸæ’åº
                    logs.sort((a, b) => b.timestamp - a.timestamp);

                    // ä¿å­˜åˆ° GitHub
                    await saveLogs(logs);

                    // é‡æ–°æ¸²æŸ“
                    await loadAndRenderLogs();

                    alert(`Excelå¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${newLogs.length} æ¡è®°å½•ã€‚`);
                } catch (error) {
                    alert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼');
                    console.error(error);
                }

                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                event.target.value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        // ä¸‹è½½ Excel æ¨¡æ¿
        function downloadExcelTemplate() {
            // å‡†å¤‡æ¨¡æ¿æ•°æ®
            const templateData = [
                ['æ—¥æœŸ', 'æ ‡é¢˜', 'ç±»å‹', 'å†…å®¹'],
                ['2025.12.26', '2025-12-26å‘¨æ›´æ–°', 'é‡è¦æ›´æ–°', 'è¿™æ˜¯ä¸€ä¸ªé‡è¦æ›´æ–°ç¤ºä¾‹\nå¯ä»¥ä½¿ç”¨æ¢è¡Œæ¥åˆ†æ®µè¯´æ˜'],
                ['2025.12.26', '2025-12-26å‘¨æ›´æ–°', 'é‡è¦æ›´æ–°', 'ç¬¬äºŒä¸ªé‡è¦æ›´æ–°é¡¹'],
                ['2025.12.26', '2025-12-26å‘¨æ›´æ–°', 'æ—¥å¸¸æ›´æ–°', 'è¿™æ˜¯ä¸€ä¸ªæ—¥å¸¸æ›´æ–°ç¤ºä¾‹'],
                ['2025.12.26', '2025-12-26å‘¨æ›´æ–°', 'æ—¥å¸¸æ›´æ–°', 'æ”¯æŒå¤šè¡Œæ–‡æœ¬\nç¬¬äºŒè¡Œå†…å®¹\nç¬¬ä¸‰è¡Œå†…å®¹'],
                ['2025.12.20', '2025-12-20å‘¨æ›´æ–°', 'é‡è¦æ›´æ–°', 'ç¤ºä¾‹é‡è¦æ›´æ–°'],
                ['2025.12.20', '2025-12-20å‘¨æ›´æ–°', 'æ—¥å¸¸æ›´æ–°', 'ç¤ºä¾‹æ—¥å¸¸æ›´æ–°1'],
                ['2025.12.20', '2025-12-20å‘¨æ›´æ–°', 'æ—¥å¸¸æ›´æ–°', 'ç¤ºä¾‹æ—¥å¸¸æ›´æ–°2']
            ];

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);

            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                { wch: 15 },  // æ—¥æœŸåˆ—
                { wch: 25 },  // æ ‡é¢˜åˆ—
                { wch: 12 },  // ç±»å‹åˆ—
                { wch: 50 }   // å†…å®¹åˆ—
            ];

            // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, 'æ›´æ–°æ—¥å¿—');

            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, 'update-logs-template.xlsx');

            alert('Excelæ¨¡æ¿ä¸‹è½½æˆåŠŸï¼\n\nä½¿ç”¨è¯´æ˜ï¼š\n1. æ‰“å¼€ä¸‹è½½çš„Excelæ–‡ä»¶\n2. å‚è€ƒç¤ºä¾‹æ ¼å¼å¡«å†™æ›´æ–°æ—¥å¿—\n3. æ—¥æœŸæ ¼å¼ï¼šYYYY.MM.DD\n4. ç±»å‹åªèƒ½å¡«ï¼šé‡è¦æ›´æ–° æˆ– æ—¥å¸¸æ›´æ–°\n5. å†…å®¹æ”¯æŒæ¢è¡Œ\n6. ä¿å­˜åé€šè¿‡"å¯¼å…¥Excel"åŠŸèƒ½å¯¼å…¥');
        }

        // è¾…åŠ©å‡½æ•°ï¼šå°†æ—¥æœŸå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¶é—´æˆ³
        function parseDateToTimestamp(dateStr) {
            try {
                // æ”¯æŒæ ¼å¼ï¼š2025.12.26 æˆ– 2025-12-26
                const normalized = dateStr.replace(/\./g, '-');
                return new Date(normalized).getTime();
            } catch (error) {
                return Date.now();
            }
        }

        // å¯¼å‡ºå…¨éƒ¨é™„ä»¶
        async function exportAllAttachments() {
            const logs = await loadLogs();
            let attachmentCount = 0;
            let base64AttachmentCount = 0;

            // ç»Ÿè®¡é™„ä»¶æ•°é‡
            logs.forEach(log => {
                if (log.attachments && log.attachments.length > 0) {
                    log.attachments.forEach(att => {
                        attachmentCount++;
                        if (!att.isLocalFile && att.data) {
                            base64AttachmentCount++;
                        }
                    });
                }
            });

            if (base64AttachmentCount === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„é™„ä»¶ï¼\n\nè¯´æ˜ï¼š\n- å¤§æ–‡ä»¶(â‰¥1MB)å·²åœ¨ä¸Šä¼ æ—¶è‡ªåŠ¨ä¸‹è½½åˆ°æœ¬åœ°\n- åªæœ‰å°æ–‡ä»¶(<1MB)å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­å¯ä»¥å¯¼å‡º');
                return;
            }

            const confirmMsg = `å‘ç° ${base64AttachmentCount} ä¸ªå¯å¯¼å‡ºçš„é™„ä»¶ï¼ˆå…±${attachmentCount}ä¸ªé™„ä»¶ï¼‰ã€‚\n\n` +
                             `è¿™äº›é™„ä»¶å°†é€ä¸ªä¸‹è½½åˆ°æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹ã€‚\n\n` +
                             `æ³¨æ„ï¼šå¤§æ–‡ä»¶(â‰¥1MB)å·²åœ¨ä¸Šä¼ æ—¶ä¸‹è½½ï¼Œæ­¤å¤„ä»…å¯¼å‡ºå°æ–‡ä»¶ã€‚\n\n` +
                             `æ˜¯å¦ç»§ç»­ï¼Ÿ`;

            if (!confirm(confirmMsg)) {
                return;
            }

            let downloadedCount = 0;

            // éå†æ‰€æœ‰æ—¥å¿—ï¼Œä¸‹è½½Base64é™„ä»¶
            logs.forEach(log => {
                if (log.attachments && log.attachments.length > 0) {
                    log.attachments.forEach(att => {
                        if (!att.isLocalFile && att.data) {
                            // å»¶è¿Ÿä¸‹è½½ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
                            setTimeout(() => {
                                downloadAttachment(att.data, att.name);
                                downloadedCount++;

                                // æœ€åä¸€ä¸ªæ–‡ä»¶ä¸‹è½½åæç¤º
                                if (downloadedCount === base64AttachmentCount) {
                                    setTimeout(() => {
                                        alert(`æˆåŠŸå¯¼å‡º ${base64AttachmentCount} ä¸ªé™„ä»¶ï¼\n\næ–‡ä»¶å·²ä¿å­˜åˆ°æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹ã€‚`);
                                    }, 500);
                                }
                            }, downloadedCount * 300); // æ¯ä¸ªæ–‡ä»¶é—´éš”300ms
                        }
                    });
                }
            });
        }

        // æ˜¾ç¤ºé™„ä»¶é¢„è§ˆ
        function showPreview(logIndex, attIndex) {
            const log = allLogsData[logIndex];
            if (!log || !log.attachments || !log.attachments[attIndex]) {
                console.error('é™„ä»¶ä¸å­˜åœ¨');
                return;
            }

            const att = log.attachments[attIndex];
            const modal = document.getElementById('previewModal');
            const content = document.getElementById('previewContent');

            content.innerHTML = `
                <img src="${att.data}" alt="${att.name}"
                     style="max-width: 100%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <div style="color: white; margin-top: 15px; font-size: 14px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 4px; display: inline-block;">
                    ${att.name}
                    <a href="javascript:void(0)" onclick="downloadAttachmentByIndex(${logIndex}, ${attIndex})"
                       style="margin-left: 15px; color: #4CAF50; text-decoration: none; font-weight: bold;">ä¸‹è½½</a>
                </div>
            `;

            modal.style.display = 'block';
        }

        // é€šè¿‡ç´¢å¼•ä¸‹è½½é™„ä»¶
        function downloadAttachmentByIndex(logIndex, attIndex) {
            const log = allLogsData[logIndex];
            if (!log || !log.attachments || !log.attachments[attIndex]) {
                console.error('é™„ä»¶ä¸å­˜åœ¨');
                return;
            }

            const att = log.attachments[attIndex];
            downloadAttachment(att.data, att.name);
        }

        // å…³é—­é¢„è§ˆ
        function closePreview(event) {
            const modal = document.getElementById('previewModal');
            // åªæœ‰ç‚¹å‡»èƒŒæ™¯æˆ–å…³é—­æŒ‰é’®æ—¶æ‰å…³é—­
            if (!event || event.target === modal || event.target.className === 'close-btn') {
                modal.style.display = 'none';
            }
        }

        // é€‰æ‹©æœ¬åœ°æ–‡ä»¶è¿›è¡Œé¢„è§ˆ
        function selectLocalFileForPreview(logIndex, attIndex) {
            const log = allLogsData[logIndex];
            if (!log || !log.attachments || !log.attachments[attIndex]) {
                console.error('é™„ä»¶å¼•ç”¨ä¸å­˜åœ¨');
                return;
            }

            const att = log.attachments[attIndex];

            // åˆ›å»ºæ–‡ä»¶é€‰æ‹©è¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'file';

            // æ ¹æ®é™„ä»¶ç±»å‹è®¾ç½®æ¥å—çš„æ–‡ä»¶ç±»å‹
            if (att.type) {
                input.accept = att.type;
            } else {
                // æ ¹æ®æ–‡ä»¶æ‰©å±•åçŒœæµ‹ç±»å‹
                const ext = att.name.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                    input.accept = 'image/*';
                } else if (['mp4', 'avi', 'mov', 'wmv'].includes(ext)) {
                    input.accept = 'video/*';
                } else if (['doc', 'docx'].includes(ext)) {
                    input.accept = '.doc,.docx';
                } else {
                    input.accept = '*/*';
                }
            }

            // æ–‡ä»¶é€‰æ‹©åçš„å¤„ç†
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) {
                    return;
                }

                // éªŒè¯æ–‡ä»¶åæ˜¯å¦åŒ¹é…ï¼ˆå¯é€‰ï¼Œç»™ç”¨æˆ·æç¤ºï¼‰
                if (file.name !== att.name) {
                    const confirmLoad = confirm(`é€‰æ‹©çš„æ–‡ä»¶å "${file.name}" ä¸åŸæ–‡ä»¶å "${att.name}" ä¸åŒ¹é…ã€‚\n\næ˜¯å¦ç»§ç»­é¢„è§ˆï¼Ÿ`);
                    if (!confirmLoad) {
                        return;
                    }
                }

                const isImage = file.type.startsWith('image/');
                const isVideo = file.type.startsWith('video/');

                if (isImage) {
                    // é¢„è§ˆå›¾ç‰‡
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        showImagePreview(event.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                } else if (isVideo) {
                    // é¢„è§ˆè§†é¢‘
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        showVideoPreview(event.target.result, file.name, file.type);
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('è¯¥æ–‡ä»¶ç±»å‹ä¸æ”¯æŒé¢„è§ˆï¼Œä»…æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘é¢„è§ˆã€‚');
                }
            };

            // è§¦å‘æ–‡ä»¶é€‰æ‹©
            input.click();
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function showImagePreview(dataUrl, filename) {
            const modal = document.getElementById('previewModal');
            const content = document.getElementById('previewContent');

            content.innerHTML = `
                <img src="${dataUrl}" alt="${escapeHtml(filename)}"
                     style="max-width: 100%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <div style="color: white; margin-top: 15px; font-size: 14px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 4px; display: inline-block;">
                    ${escapeHtml(filename)} [æœ¬åœ°æ–‡ä»¶]
                </div>
            `;

            modal.style.display = 'block';
        }

        // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ
        function showVideoPreview(dataUrl, filename, mimeType) {
            const modal = document.getElementById('previewModal');
            const content = document.getElementById('previewContent');

            content.innerHTML = `
                <video controls autoplay preload="metadata"
                       style="max-width: 100%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <source src="${dataUrl}" type="${mimeType}">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <div style="color: white; margin-top: 15px; font-size: 14px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 4px; display: inline-block;">
                    ${escapeHtml(filename)} [æœ¬åœ°æ–‡ä»¶]
                </div>
            `;

            modal.style.display = 'block';
        }
    </script>
</body>
</html>
